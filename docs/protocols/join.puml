@startuml join
title
Join protocol
end title
autonumber

box "Platform"
participant TPM
participant "Attester\nAgent" as attester_agent
endbox
participant "Join\nService" as join_service

== LAK creation ==
TPM<-attester_agent: tpm_createak
TPM<-TPM:  Generate LAK

== Start Join protocol ==
TPM<-attester_agent: request EK_cert
TPM->attester_agent: EK_cert
attester_agent->join_service: request to join, LAK csr, EK cert
note right
The attester notifies its presence.
The join server responds with a challenge,
or OK if already in its group
end note

alt alredy joined
  join_service->attester_agent: OK
else join
  join_service->join_service: validate EK_cert
  note right
    TPM is authentic
    (validation of the EK certificate OK)
  end note
  join_service->join_service: tpm_makecredential\nchallenge = enc(EK_pub, nonce, LAK_pub)
  attester_agent<-join_service: challenge
  TPM<-attester_agent: tpm_activatecredential
  note left
    tpm_activate credential verifies
    the possession of AK_priv, EK_priv
    and verifies that they are in the
    same TPM
  end note
  TPM<-TPM: dec(EK_priv, challenge)
  TPM->attester_agent: nonce
  attester_agent->join_service: nonce
  join_service->join_service: Add LAK to DB
  join_service->Verifiers: notify verifiers of new agent in the group
end

@enduml
